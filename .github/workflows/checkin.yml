name: Checkin

on:
  schedule:
    # UTC æ—¶é—´ 4:00-14:00 = åŒ—äº¬æ—¶é—´ 12:00-22:00ï¼Œæ¯å°æ—¶è§¦å‘
    - cron: '0 4-14 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæ‰‹åŠ¨è§¦å‘ç›´æ¥æ‰§è¡Œï¼Œä¸éšæœºï¼‰

jobs:
  checkin:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ² éšæœºå†³å®šæ˜¯å¦æ‰§è¡Œ & éšæœºå»¶è¿Ÿ
        id: random
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "æ‰‹åŠ¨è§¦å‘ï¼Œç›´æ¥æ‰§è¡Œ"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            # ç”Ÿæˆ 1-11 çš„éšæœºæ•°ï¼Œåªæœ‰ç­‰äº 1 æ—¶æ‰æ‰§è¡Œï¼ˆçº¦ 1/11 æ¦‚ç‡ï¼Œæ¯å¤©å‘½ä¸­ä¸€æ¬¡ï¼‰
            RAND=$(shuf -i 1-11 -n 1)
            echo "éšæœºæ•°: $RAND"
            if [ "$RAND" -eq 1 ]; then
              # éšæœºå»¶è¿Ÿ 0-3500 ç§’ï¼ˆçº¦ 0-58 åˆ†é’Ÿï¼‰
              DELAY=$(shuf -i 0-3500 -n 1)
              echo "ğŸ¯ å‘½ä¸­æ‰§è¡Œï¼å»¶è¿Ÿ ${DELAY} ç§’åå¼€å§‹..."
              sleep $DELAY
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "â­ï¸ æœ¬æ¬¡è·³è¿‡"
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        if: steps.random.outputs.should_run == 'true'
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½® Python ç¯å¢ƒ
        if: steps.random.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        if: steps.random.outputs.should_run == 'true'
        run: pip install requests beautifulsoup4

      - name: âœ… è¿è¡Œç­¾åˆ°è„šæœ¬
        if: steps.random.outputs.should_run == 'true'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          USER1: ${{ secrets.USER1 }}
          PASS1: ${{ secrets.PASS1 }}
        run: python checkin.py
        timeout-minutes: 5

      - name: ğŸ“Œ æ‰§è¡Œå®Œæˆ
        if: steps.random.outputs.should_run == 'true'
        run: echo "ç­¾åˆ°ä»»åŠ¡å·²å®Œæˆ âœ…"

  keepalive-workflow:
    name: Keepalive Workflow
    if: ${{ always() }}
    needs: checkin
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - uses: liskin/gh-workflow-keepalive@v1
