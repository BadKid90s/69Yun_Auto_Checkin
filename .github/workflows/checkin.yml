name: Checkin

on:
  schedule:
    # UTC æ—¶é—´ 4:00-14:00 = åŒ—äº¬æ—¶é—´ 12:00-22:00ï¼Œæ¯å°æ—¶è§¦å‘
    - cron: '0 4-14 * * *'
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ² éšæœºå†³å®šæ˜¯å¦æ‰§è¡Œ & éšæœºå»¶è¿Ÿ
        id: random
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "æ‰‹åŠ¨è§¦å‘ï¼Œç›´æ¥æ‰§è¡Œ"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            RAND=$(shuf -i 1-11 -n 1)
            echo "éšæœºæ•°: $RAND"
            if [ "$RAND" -eq 1 ]; then
              DELAY=$(shuf -i 0-3500 -n 1)
              echo "ğŸ¯ å‘½ä¸­æ‰§è¡Œï¼å»¶è¿Ÿ ${DELAY} ç§’åå¼€å§‹..."
              sleep $DELAY
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "â­ï¸ æœ¬æ¬¡è·³è¿‡"
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        if: steps.random.outputs.should_run == 'true'
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½® Python ç¯å¢ƒ
        if: steps.random.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        if: steps.random.outputs.should_run == 'true'
        run: pip install requests beautifulsoup4

      - name: âœ… è¿è¡Œç­¾åˆ°è„šæœ¬å¹¶è®°å½•æ—¥å¿—
        if: steps.random.outputs.should_run == 'true'
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          USER1: ${{ secrets.USER1 }}
          PASS1: ${{ secrets.PASS1 }}
        run: |
          # è¿è¡Œç­¾åˆ°è„šæœ¬ï¼Œæ•è·è¾“å‡º
          python checkin.py 2>&1 | tee output.txt

          # è·å–åŒ—äº¬æ—¶é—´
          DATETIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')

          # ä»è¾“å‡ºä¸­æå–å‰©ä½™æµé‡
          REMAINING=$(grep -oP 'å‰©ä½™æµé‡: \K[^\s]+' output.txt || echo "æœªçŸ¥")

          # ä»è¾“å‡ºä¸­æå–ç­¾åˆ°ç»“æœ
          RESULT=$(grep -oP 'ç­¾åˆ°ç»“æœ: \K.*' output.txt || echo "æœªçŸ¥")

          # ä»è¾“å‡ºä¸­æå–ç­¾åˆ°è·å¾—çš„æµé‡
          TRAFFIC=$(grep -oP 'è·å¾—äº†?\s*\K[\d.]+\s*(MB|GB|TB)' output.txt || echo "0MB")

          # å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºè¡¨å¤´
          if [ ! -f checkin.log ]; then
            echo "====================================================================" >> checkin.log
            echo "                        69äº‘è‡ªåŠ¨ç­¾åˆ°æ—¥å¿—                              " >> checkin.log
            echo "====================================================================" >> checkin.log
            echo "æ—¥æœŸ        æ—¶é—´      | å‰©ä½™æµé‡    | ç­¾åˆ°æµé‡  | ç­¾åˆ°ç»“æœ" >> checkin.log
            echo "--------------------------------------------------------------------" >> checkin.log
          fi

          # å†™å…¥æ—¥å¿—
          echo "${DATETIME} | ${REMAINING} | ${TRAFFIC} | ${RESULT}" >> checkin.log

          echo "ğŸ“ æ—¥å¿—å·²è®°å½•"
          cat checkin.log
        timeout-minutes: 5

      - name: ğŸ“ æäº¤æ—¥å¿—åˆ°ä»“åº“
        if: steps.random.outputs.should_run == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add checkin.log
          git diff --staged --quiet || git commit -m "ğŸ“ ç­¾åˆ°æ—¥å¿— $(TZ='Asia/Shanghai' date +'%Y-%m-%d')"
          git push

      - name: ğŸ“Œ æ‰§è¡Œå®Œæˆ
        if: steps.random.outputs.should_run == 'true'
        run: echo "ç­¾åˆ°ä»»åŠ¡å·²å®Œæˆ âœ…"

  keepalive-workflow:
    name: Keepalive Workflow
    if: ${{ always() }}
    needs: checkin
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - uses: liskin/gh-workflow-keepalive@v1
